ARG BUILD_FROM
ARG ZEROCLAW_VERSION="main" # é»˜è®¤æ‹‰å– main åˆ†æ”¯çš„æœ€æ–°ä»£ç ï¼Œä¹Ÿå¯ä»¥å†™å…·ä½“çš„ tag å¦‚ v0.1.0

# ---------------------------------------------------------
# é˜¶æ®µ 1ï¼šæ„å»ºç¯å¢ƒ (Builder)
# ä½¿ç”¨å®˜æ–¹ Rust é•œåƒæ¥ç¼–è¯‘ ZeroClaw
# ---------------------------------------------------------
FROM rust:alpine AS builder

# å®‰è£…ç¼–è¯‘æ‰€éœ€çš„ä¾èµ–ï¼šAlpine ä½¿ç”¨ muslï¼Œæ‰€ä»¥éœ€è¦å®‰è£…å¯¹åº”çš„æ„å»ºå·¥å…·
RUN apk add --no-cache musl-dev gcc make pkgconfig openssl-dev

# å°†å·¥ä½œç›®å½•è®¾ä¸º /app
WORKDIR /app

# ä» GitHub ç›´æ¥æ‹‰å– ZeroClaw æºç ä»“åº“
# depth=1 å¯ä»¥æå¤§åœ°åŠ å¿«å…‹éš†é€Ÿåº¦ï¼Œä¸æ‹‰å–å†å²è®°å½•
RUN apk add --no-cache git \
    && echo "ğŸš€ Cloning ZeroClaw repository..." \
    && git clone --depth=1 https://github.com/zeroclaw-labs/zeroclaw.git .

# å¼€å§‹ Rust ç¼–è¯‘ï¼šä½¿ç”¨ release é…ç½®ä»¥è·å¾—æœ€å°ã€æœ€å¿«çš„äºŒè¿›åˆ¶æ–‡ä»¶
# æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ codegen-units=1 å¯ä»¥åœ¨ä½ç«¯æ¿å­ä¸Šè·å¾—æœ€ä½³æ€§èƒ½
RUN echo "âš™ï¸ Building ZeroClaw (this may take a few minutes)..." \
    && cargo build --profile release-fast --locked


# ---------------------------------------------------------
# é˜¶æ®µ 2ï¼šè¿è¡Œç¯å¢ƒ (Runner)
# è¿™ä¸€æ­¥å°†å›åˆ° HA çš„åŸºç¡€é•œåƒï¼Œåªå¤åˆ¶æˆ‘ä»¬åˆšæ‰ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
# ---------------------------------------------------------
FROM $BUILD_FROM

# å®‰è£… ZeroClaw è¿è¡Œæ—¶å¿…éœ€çš„æœ€åŸºç¡€å·¥å…·
# jq å’Œ bash ç”¨äºè¿è¡Œ run.shï¼Œcurl ç”¨äºå¯èƒ½çš„æ•°æ®è¯·æ±‚ï¼Œtzdata ç”¨äºæ—¶åŒºï¼Œ
# libc6-compat ä¾ç„¶ä¿ç•™ï¼Œä»¥é˜²ä¸‡ä¸€æŸäº›å¤–éƒ¨ç»‘å®šéœ€è¦ã€‚
RUN apk add --no-cache \
    bash \
    curl \
    jq \
    tzdata \
    ca-certificates \
    libc6-compat

# ä»é˜¶æ®µ 1 (builder) çš„é•œåƒé‡Œï¼ŒæŠŠç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶â€œå·â€è¿‡æ¥
# æ”¾åœ¨ /usr/bin/zeroclaw ç›®å½•ä¸‹
COPY --from=builder /app/target/release-fast/zeroclaw /usr/bin/zeroclaw

# èµ‹äºˆå¯æ‰§è¡Œæƒé™
RUN chmod +x /usr/bin/zeroclaw

# æ¤å…¥æˆ‘ä»¬çš„å¯åŠ¨è„šæœ¬
COPY run.sh /run.sh
RUN chmod +x /run.sh

# è®¾å®šå®¹å™¨å…¥å£
CMD [ "/run.sh" ]